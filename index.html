<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ•™è‚²ç§‘æŠ€æ–‡å­—æ‰è½éŠæˆ²ï¼ˆå–®æ‰‹ç‰ˆï¼‰</title>
  <style>
    body {
      margin: 0;
      font-family: 'Microsoft JhengHei', sans-serif;
      background-color: #000;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      padding: 20px;
    }
    #info {
      width: 180px;
    }
    #info h3 {
      margin-bottom: 0.5em;
    }
    #canvas-container {
      position: relative;
    }
    canvas {
      display: block;
      border: 2px solid #fff;
    }
    #overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      font-size: 18px;
    }
    #right {
      width: 200px;
    }
    button {
      margin-top: 10px;
      font-size: 16px;
      padding: 4px 10px;
      cursor: pointer;
    }
  </style>
  <!-- è¼‰å…¥ p5.js åŠ ml5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.1/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
</head>
<body>
  <!-- å·¦å´ï¼šå­¸ç”Ÿè³‡è¨Š + æŒ‰éˆ• -->
  <div id="info">
    <h3>æ•™ç§‘ä¸€B</h3>
    <p>413730770</p>
    <p>æè•™èŠ¯</p>
    <button id="startButton">é–‹å§‹éŠæˆ²</button>
    <button id="restartButton" style="display:none;">é‡æ–°é–‹å§‹</button>
  </div>

  <!-- ä¸­é–“ï¼šç•«å¸ƒå®¹å™¨èˆ‡åˆ†æ•¸ã€æ™‚é–“è¦†è“‹å±¤ -->
  <div id="canvas-container">
    <div id="overlay">
      <div id="scoreBoard">åˆ†æ•¸: 0</div>
      <div id="timeBoard">æ™‚é–“: 30 ç§’</div>
    </div>
    <!-- p5.js æœƒåœ¨é€™è£¡å‹•æ…‹å»ºç«‹ canvas -->
  </div>

  <!-- å³å´ï¼šéŠæˆ²èªªæ˜ -->
  <div id="right">
    <h3>ğŸ® éŠæˆ²èªªæ˜</h3>
    <ul>
      <li>ä½¿ç”¨ã€Œå–®æ‰‹é£ŸæŒ‡ã€é»æ“Šä¸‹è½çš„ä¸­æ–‡å­—</li>
      <li>æ¯é»ä¸€å€‹æ–‡å­—å³å¯ +10 åˆ†</li>
      <li>é™æ™‚ 30 ç§’ï¼Œçœ‹çœ‹èƒ½å¾—å¹¾åˆ†ï¼</li>
    </ul>
  </div>

  <!-- ä»¥ä¸‹æ˜¯ JavaScript ç¨‹å¼ -->
  <script>
    // å…¨åŸŸè®Šæ•¸
    let video;
    let handpose;
    let predictions = [];

    let grid = [];
    let cols, rows;
    let size = 30;
    let eduWords = ["æ•™", "è‚²", "ç§‘", "æŠ€"];

    let score = 0;
    let gameDuration = 30; // éŠæˆ²ç§’æ•¸
    let startTime;
    let gameState = "start"; // start, playing, gameover

    // å¾ HTML æ‹¿åˆ°å…ƒç´ 
    const scoreBoard = document.getElementById('scoreBoard');
    const timeBoard = document.getElementById('timeBoard');
    const startButton = document.getElementById('startButton');
    const restartButton = document.getElementById('restartButton');

    function setup() {
      // å»ºç«‹ 640x480 çš„ç•«å¸ƒï¼Œä¸¦æ”¾åˆ° #canvas-container
      const canvas = createCanvas(640, 480);
      canvas.parent('canvas-container');
      textFont('Microsoft JhengHei');

      // å»ºç«‹æ”å½±æ©Ÿè¼¸å…¥ï¼Œä½†éš±è—åŸç”Ÿ <video> å…ƒç´ 
      video = createCapture(VIDEO);
      video.size(width, height);
      video.hide();

      // åˆå§‹åŒ– ml5 handpose æ¨¡å‹
      handpose = ml5.handpose(video, () => {
        console.log("Handpose æ¨¡å‹å·²è¼‰å…¥");
      });
      handpose.on("predict", (results) => {
        predictions = results;
      });

      // è¨ˆç®—ç¶²æ ¼è¡Œåˆ—
      cols = floor(width / size);
      rows = floor(height / size);
      for (let i = 0; i < cols; i++) {
        grid[i] = [];
        for (let j = 0; j < rows; j++) {
          grid[i][j] = null;
        }
      }

      noLoop(); // é è¨­åœæ­¢ draw()

      // ç¶å®šæŒ‰éˆ•äº‹ä»¶
      startButton.onclick = () => {
        startGame();
      };
      restartButton.onclick = () => {
        resetGame();
        startGame();
      };
    }

    function draw() {
      background(0);
      if (gameState === "playing") {
        playGame();
      }
    }

    function playGame() {
      // å…ˆæŠŠæ”å½±æ©Ÿç•«é¢é¡åƒé¡¯ç¤º
      push();
      translate(width, 0);
      scale(-1, 1);
      image(video, 0, 0, width, height);
      pop();

      // è¨ˆç®—å‰©é¤˜æ™‚é–“
      let elapsed = floor((millis() - startTime) / 1000);
      let timeLeft = max(0, gameDuration - elapsed);
      timeBoard.textContent = `æ™‚é–“: ${timeLeft} ç§’`;

      // æ™‚é–“åˆ°å°±çµæŸéŠæˆ²
      if (timeLeft <= 0) {
        gameOver();
        return;
      }

      // æ¯ 40 å¹€æ–°å¢ä¸€å€‹æ–‡å­— (é€Ÿåº¦è¼ƒæ…¢)
      if (frameCount % 40 === 0) {
        addWord(floor(random(cols)), 0);
      }

      // å–®æ‰‹é£ŸæŒ‡åµæ¸¬ï¼šå¦‚æœç¢°åˆ°æ ¼å­è£¡æœ‰æ–‡å­—ï¼Œå°±æ¶ˆé™¤ä¸¦åŠ åˆ†
      if (predictions.length > 0) {
        // åƒ…å–ç¬¬ä¸€éš»æ‰‹çš„ indexFinger[3]
        let tip = predictions[0].annotations.indexFinger[3];
        let x = width - tip[0]; // é¡åƒå¾Œçš„ x åº§æ¨™
        let y = tip[1];        // y åº§æ¨™

        // ç•«å‡ºç´…é»æŒ‡ç¤ºé£ŸæŒ‡
        fill(255, 0, 0);
        noStroke();
        ellipse(x, y, 20);

        // è¨ˆç®—è½åœ¨å“ªå€‹æ ¼å­
        let gridX = floor(x / size);
        let gridY = floor(y / size);

        // å¦‚æœè©²æ ¼æœ‰æ–‡å­—ï¼Œå°±æ¶ˆé™¤ä¸¦åŠ  10 åˆ†
        if (
          gridX >= 0 &&
          gridX < cols &&
          gridY >= 0 &&
          gridY < rows &&
          grid[gridX][gridY] !== null
        ) {
          grid[gridX][gridY] = null;
          score += 10;
          scoreBoard.textContent = `åˆ†æ•¸: ${score}`;
        }
      }

      // è™•ç†æ–‡å­—ä¸‹è½
      let nextGrid = [];
      for (let i = 0; i < cols; i++) {
        nextGrid[i] = [];
        for (let j = 0; j < rows; j++) {
          nextGrid[i][j] = null;
        }
      }

      for (let i = 0; i < cols; i++) {
        for (let j = rows - 1; j >= 0; j--) {
          if (grid[i][j]) {
            if (j + 1 < rows && grid[i][j + 1] === null) {
              nextGrid[i][j + 1] = grid[i][j];
            } else {
              nextGrid[i][j] = grid[i][j];
            }
          }
        }
      }
      grid = nextGrid;

      // ç¹ªè£½æ‰€æœ‰æ–‡å­—
      textAlign(CENTER, CENTER);
      fill(255);
      textSize(size);
      for (let i = 0; i < cols; i++) {
        for (let j = 0; j < rows; j++) {
          if (grid[i][j]) {
            text(grid[i][j], i * size + size / 2, j * size + size / 2);
          }
        }
      }
    }

    // åœ¨ (x, y) æ ¼å­éš¨æ©Ÿæ”¾ä¸€å€‹æ–‡å­—
    function addWord(x, y) {
      if (grid[x][y] === null) {
        grid[x][y] = random(eduWords);
      }
    }

    function startGame() {
      gameState = "playing";
      score = 0;
      scoreBoard.textContent = "åˆ†æ•¸: 0";
      startTime = millis();
      loop(); // é–‹å§‹ draw()
      startButton.style.display = "none";
      restartButton.style.display = "none";
    }

    function gameOver() {
      gameState = "gameover";
      noLoop(); // åœæ­¢ draw()
      restartButton.style.display = "inline-block";
      alert(`éŠæˆ²çµæŸï¼\nä½ çš„åˆ†æ•¸ï¼š${score}`);
    }

    function resetGame() {
      // æ¸…ç©ºç¶²æ ¼
      for (let i = 0; i < cols; i++) {
        for (let j = 0; j < rows; j++) {
          grid[i][j] = null;
        }
      }
      score = 0;
      scoreBoard.textContent = "åˆ†æ•¸: 0";
      timeBoard.textContent = `æ™‚é–“: ${gameDuration} ç§’`;
      startButton.style.display = "inline-block";
      restartButton.style.display = "none";
    }
  </script>
</body>
</html>
